        <!DOCTYPE html>
        <html lang="en">
        	<head>
        		<meta charset="utf-8">
        		<title>Channelling Hans</title>
        		<script type="text/javascript" src="d3.js"></script>
        		<style type="text/css">
        		</style>

        		<table border="0">
                <tr>
                    <th rowspan="2"><div id="chart1"></div></th>
                    <td><div id="chart2" ></div></td>
                    </tr>
                    <tr>
                    <td><div id="chart3" ></div></td>
                </tr>
            </table>
        	</head>

        	
            <body>
                
        		<script>
            // Chart dimensions.
            var margin = {top: 30, right: 30, bottom: 30, left: 40};
            var data;
        		var w = 1200 - margin.right;
            var h = 600 - margin.top - margin.bottom;
            var buffer = 20;
            var font = '"Bariol Regular",Lucida Sans Unicode,Lucida Grande,sans-serif';
            var xScale, yScale, rScale, cScale;
            var yearCount = 0;
            var initialTimer;
            var selected;

            // main_svg for main canvas
            var main_svg = d3.select("body").append("svg")
              .attr("width", w + margin.left + margin.right)
              .attr("height", h + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                
        		d3.csv("GCI_CompleteData4_test_dataset.csv", function(error, dataset) {
              if(error) {
                console.log(error);
              } else {
                data = dataset;
                data.forEach(function(d){ 
                    // for animation
                    d.Year = +d.Year;

                    //bubble area size
                    d.Population = +d.Population;

                    //for y axis
                    d.Global_Competitiveness_Index = +d.Global_Competitiveness_Index;
                    
                    //for x axis
                    d.GDP = +d.GDP;
                    d.Area = +d.Area;

                    // console.log(d.Global_Competitiveness_Index);
                });
              }

                // scaling the attribute values
                var minGDP = d3.min(data, function(d) {
                              return +d.GDP; });
                var maxGDP = d3.max(data, function(d) {
                              return +d.GDP; });
                var minGCI = d3.min(data, function(d) {
                              return +d.Global_Competitiveness_Index; });
                var maxGCI = d3.max(data, function(d) {
                              return +d.Global_Competitiveness_Index; });
                var minPop = d3.min(data, function(d) {
                              return +d.Population; });
                var maxPop = d3.max(data, function(d) {
                              return +d.Population; });
                        
                //console.log(minGDP);

                // scaling the attributes values for better readability

                // x-axis log scale for GDP
                xScale = d3.scaleLog();
                xScale.domain([minGDP, maxGDP]);
                xScale.range([(buffer*2), w-buffer]);
                    
               // console.log(xScale);

                // linear scale for for Global competitive index
                yScale = d3.scaleLinear();
                yScale.domain([minGCI, maxGCI]);
                yScale.range([h-(buffer*2), (buffer*2)]);

                // sqrt scale for bubble radius
                rScale = d3.scaleSqrt(); 
                rScale.domain([minPop, maxPop]);
                rScale.range([2, ((w*h)/10000)]);

                // linear scale for year
                yearScale = d3.scaleLinear().domain([70, 336])
                            .range([0,130]);

                // x axis GDP
                var gdp_axis = d3.axisBottom(xScale);
                gdp_axis.tickArguments([10, "d"]);

                // y axis GCI
                var gci_axis = d3.axisLeft(yScale);
                gci_axis.tickArguments([4]);

                var formatAsWholeNum = d3.format("d");

                // cScale colours each region's circles a unique colour
                cScale = d3.scaleOrdinal(d3.schemeCategory10);
                cScale.domain(["Europe", "Asia", "Africa", "North America", "South America", "Australia", "Central America", "Oceania"]);    
                     
                // preprocess data, nesting it and ordering it appropriately
                data = prepData(data);

                // gridlines in x axis function
              function make_x_gridlines() {   
                  return d3.axisBottom(xScale).ticks(5);
              }

              // gridlines in y axis function
              function make_y_gridlines() {   
                  return d3.axisLeft(yScale).ticks(5);
              }            


              // add the X gridlines
              main_svg.append("g")     
                  .attr("class", "grid")
                  .attr("transform", "translate(0," + h + ")")
                  .call(make_x_gridlines()
                      .tickSize(-h)
                      .tickFormat("")
                  ).style("opacity", 0.2);

              // add the Y gridlines
              main_svg.append("g")     
                  .attr("class", "grid")
                  .call(make_y_gridlines()
                      .tickSize(-w)
                      .tickFormat("")
                  ).style("opacity", 0.2);
              
                // attaching both x and y axis to main svg 
                main_svg.append("g").attr("transform", "translate(0," + 
                         (h-buffer) + ")").call(gdp_axis);
                
                main_svg.append("g").attr("transform", "translate(" + 
                         buffer + ",0)").call(gci_axis);

                // adding  main-label for GDP on x-axis
                main_svg.append("text").attr("text-anchor", "middle")
                        .text("Income")
                        .attr("x", w-(w/2)).attr("y", h + (h/20))
                        .attr("font-size", 25).style('font-family', font)
                        .attr("fill", "#073F59").style("opacity", 0.8);

                // adding  mini-label for GDP on x-axis
                main_svg.append("text").attr("text-anchor", "end")
                        .text("per person (GDP/capita,PPPS inflation-adjusted)")
                        .attr("x", w-(w/40)).attr("y", h - (h/22))
                        .attr("font-size", 13).attr("font-family", font)
                        .attr("fill", "#073F59").style("opacity", 0.8);

                // adding  main-label for GCI on y-axis
                main_svg.append("text").attr("text-anchor", "middle")
                        .text("Global Competitiveness Index")
                        .attr("x", -(w/5)).attr("font-size", 21)
                        .style('font-family', font).attr("fill", "#073F59")
                        .style("opacity", 0.8).attr("transform", "rotate(-90)");

                // adding mini-label for Global comp score on y-axis
                main_svg.append("text").attr("text-anchor", "end")
                        .text("Score")
                        .attr("x", -(w/30)).attr("y", buffer*2)
                        .attr("font-size", 13).attr("font-family", font)
                        .attr("fill", "#073F59").attr("transform", "rotate(-90)")
                        .style("opacity", 0.8);


              // create year box which displays year and can control the year on mouseover
              var labelYear= main_svg.append("text")
                                  .attr("class", "labelYear2")
                                  .attr("text-anchor", "start")
                                  .attr("x", w/5.5).attr("y", h/1.5)
                                  .attr("font-size", 300)
                                  .attr("fill", "#666")
                                  .style("opacity", 0.3)
                                  .attr("font-family", font)
                                  .on("mousemove", function(d) {
                                    var coord = [0,0];
                                    coord = d3.mouse(this);
                                    var x = coord[0];
                                    x = Math.round(yearScale(x));
                                    if (initialTimer !== null) clearInterval(initialTimer);
                                    genVis(data[x].values);
                                  });

              // create text box to show when a region is selected
              var selectRegion = main_svg.append("text")
                                  .attr("class", "regionClick")
                                  .attr("text-anchor", "end")
                                  .attr("x", w - (w/10))
                                  .attr("y", h - buffer*10)
                                  .attr("font-size", 60)
                                  .attr("fill", "gray")
                                  .style("opacity", 0.8)
                                  .attr("font-family", font);
              
              // text box to display a country's name when it is clicked on.
              var selectCountry = main_svg.append("text")
                                      .attr("class", "countryMouseover")
                                      .attr("text-anchor", "middle")
                                      .attr("x", w - (w/2))
                                      .attr("y", h - (h/8))
                                      .attr("font-size", 15)
                                      .attr("fill", "teal")
                                      .style("opacity", 0.8)
                                      .attr("font-family", font);


              // create timer which will call the generate vis function every second
              initialTimer = setInterval(function() {
                                  if (yearCount == 70) clearInterval(initialTimer);
                                  genVis(data[yearCount].values);
                                  yearCount += 1;
                                }, 1000);
              
              // call the timer to begin the animation
              initialTimer();
              
              

                  function prepData(data) {
                    // Nest data into array of year-based arrays
                    
                    // sort all data points into ascending year oder
                    data.sort(function(a,b) {
                      return a.Year - b.Year;
                    });
                
                    // create nest of all years to split them apart
                    var yearNest = d3.nest()
                                    .key(function(d) { 
                                      return d.Year;})
                                    .entries(data);
                    
                    return yearNest;
                  }

                  function genVis(data_by_year) {
                    // bind circles object to all circles on canvas and supply data, with country as key

                    var circles = main_svg.selectAll("circle")
                                  .data(data_by_year, function key(d) {
                                      return d.Country;
                                  });

                    // update selection
                    circles.transition().delay(50)
                        .duration(1000)
                        .attr("cx", function(d) {
                            return xScale(+d.GDP); })
                        .attr("cy", function(d) { 
                            return yScale(+d.Global_Competitiveness_Index); })
                        .attr("r", function(d) {
                            return rScale(+d.Population/ Math.PI);
                        })
                        .attr("fill", function(d) { 
                            return cScale(d.Region); })
                        .style("opacity", 0.5)
                        .attr("stroke", "black");
                                  
                    // enter selection
                    circles.enter().append("circle")
                        .attr("cx", function(d) {
                            return xScale(+d.GDP); })
                        .attr("cy", function(d) {
                            return yScale(+d.Global_Competitiveness_Index); })
                        .attr("r", function(d) {
                            return rScale(Math.sqrt(+d.Population / Math.PI)); 
                        })
                        .attr("fill", function(d) { 
                            return cScale(d.Region); 
                        })
                        .attr("class", function(d) {
                            return (d.Region).replace(" ", "_"); 
                        })
                        .attr("stroke", "black")
                        .style("opacity", 0.6)
                        .on("mouseover", function(d) { 
                            // highlight bubble on selection
                            // changing opacity for remaining bubbles
                            main_svg.selectAll("circle") 
                                    .transition()
                                    .duration(300)
                                    .style("opacity", 0.2);
                    
                            d3.select(this).style("opacity", 0.8) 
                            // turn the current circle to normal opacity
                                .transition()
                                .duration(0);
                    
                            main_svg.select(".regionClick")
                                .text("")
                                .transition()
                                .duration(100);
                            
                            main_svg.select(".countryMouseover") 
                            // tell which country it is in the country box
                                .text('Country: ' + d.Country + ' Population: ' + d.Population + ' GCI:' + d.Global_Competitiveness_Index)
                                .transition()
                                .duration(100);

                        })
                        .on("mouseout", function(d) { 
                            if (selected !== true) {
                              main_svg.selectAll("circle")
                                    .transition()
                                    .duration(0)
                                    .style("opacity", 0.6);
                            }
                    
                            main_svg.select(".countryMouseover")
                                        .text('')
                                        .transition()
                                        .duration(100);
                        })
                        .on("click", function(d) {
                            selected = true;
                            var r = d3.select(this).data();
                            
                            main_svg.selectAll("circle")
                                .style("opacity", 0.1)
                                .transition()
                                .duration(300);
                    
                            main_svg.select(".regionClick")
                                .text(r[0].Region + " Region")
                                .attr("fill", cScale(r[0].Region))
                                .transition()
                                .duration(100);
                    
                            main_svg.selectAll("." + (r[0].Region).replace(" ", "_"))
                                .style("opacity", 1)
                                .transition()
                                .duration(0);
                        })
                
                        .transition()
                        .duration(1000);
                
                // exit selection
                circles.exit()
                        .transition()
                        .duration(50)
                        .remove();

                main_svg.select(".labelYear2") 
                    // control the year text to reflect the data
                    .transition()
                    .text(data_by_year[0].Year);
                }
        });
        </script>

    <!-- <button onclick=""> -->
    <img id="imageid2" src="./../data/play.png" style="width:20px">
    <img id="imageid" src="./../data/pause.png" style="width:12px;display:none">
    
    <!-- </button> -->
    <label for="myDropDownList">Country</label>
    <select id="country">
      <option selected="All">All</option> 
      <option value="China" >China</option> 
      <option value="India">India</option> 
      <option value="Brazil">Brazil</option> 
      <option value="United States">USA</option> 
      <option value="Indonesia">Indonesia</option> 
      <option value="Pakistan">Pakistan</option> 
      <option value="Nigeria">Nigeria</option> 
      <option value="Bangladesh">Bangladesh</option> 
      <option value="Russia">Russia</option> 
      <option value="Mexico">Mexico</option> 
    </select>

    <script>
      $("#imageid").click(function(){ 
          $("#imageid2").show();
          mediaflag= false;$("#imageid").hide();
        });
      $("#imageid2").click(function(){ 
          $("#imageid").show();
          mediaflag = true;$("#imageid2").hide();
        });
      $("#year").change(function(){
          $("#imageid").trigger('click');
        });
    </script>   
  </body>
</html>